name: Jackpot Draw

on:
  schedule:
    - cron: '0 17 * * *' # 18:00 ZÃ¼rich (CET)
  workflow_dispatch:

jobs:
  draw:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout repo
        uses: actions/checkout@v4

      - name: Update jackpot
        run: |
          FILE="jackpot.json"

          if [ ! -f "$FILE" ]; then
            echo '{
              "amount": 10,
              "winnerFound": false,
              "lastDrawDate": null,
              "jackpot": 10,
              "updatedAt": null
            }' > $FILE
          fi

          AMOUNT=$(jq '.amount' $FILE)
          JACKPOT=$(jq '.jackpot' $FILE)

          # Gewinnchance: 1 %
          WIN=$((RANDOM % 100))

          TODAY=$(date -u +"%Y-%m-%d")
          NOW=$(date -u +"%Y-%m-%dT%H:%M:%SZ")

          if [ "$WIN" -eq 0 ]; then
            NEW_JACKPOT=$AMOUNT
            WINNER=true
          else
            NEW_JACKPOT=$((JACKPOT + AMOUNT))
            WINNER=false
          fi

          jq \
            --argjson jackpot $NEW_JACKPOT \
            --argjson winnerFound $WINNER \
            --arg lastDrawDate "$TODAY" \
            --arg updatedAt "$NOW" \
            '.jackpot=$jackpot
             | .winnerFound=$winnerFound
             | .lastDrawDate=$lastDrawDate
             | .updatedAt=$updatedAt' \
            $FILE > tmp.json && mv tmp.json $FILE

      - name: Commit changes
        run: |
          git config user.name "jackpot-bot"
          git config user.email "bot@users.noreply.github.com"
          git add jackpot.json
          git commit -m "ðŸŽ‰ Jackpot update" || echo "No changes"
          git push
