name: Jackpot Draw (Zurich)

permissions:
  contents: write   # ðŸ”‘ OHNE DAS KANN DIE DATEI NICHT GEÃ„NDERT WERDEN

on:
  schedule:
    - cron: "*/5 * * * *"   # Script entscheidet selbst
  workflow_dispatch:
    inputs:
      force:
        description: "Force draw now (initial run)"
        required: false
        default: "false"

jobs:
  draw:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Run jackpot draw
        run: |
          node <<'EOF'
          const fs = require("fs");

          const FILE = "jackpot.json";
          const START = 10;
          const STEP = 10;

          const FORCE = process.env.FORCE_RUN === "true";

          function getZurich(date = new Date()) {
            const f = new Intl.DateTimeFormat("sv-SE", {
              timeZone: "Europe/Zurich",
              year: "numeric", month: "2-digit", day: "2-digit",
              hour: "2-digit", minute: "2-digit", second: "2-digit",
              hour12: false
            }).format(date);
            const [d, t] = f.split(" ");
            const [hh, mm, ss] = t.split(":").map(Number);
            return { date: d, hh, mm, ss, raw: f };
          }

          const z = getZurich();

          if (!FORCE && !(z.hh === 18 && z.mm === 0)) {
            process.exit(0);
          }

          const data = JSON.parse(fs.readFileSync(FILE, "utf8"));

          if (!FORCE && data.lastDrawDate === z.date) {
            process.exit(0);
          }

          const winnerFound = Math.random() < 0.05;

          data.winnerFound = winnerFound;
          data.lastDrawDate = z.date;

          data.jackpot = winnerFound
            ? START
            : (typeof data.jackpot === "number" ? data.jackpot : START) + STEP;

          delete data.amount;

          data.updatedAtZurich = z.raw;
          data.updatedAtUtc = new Date().toISOString();

          fs.writeFileSync(FILE, JSON.stringify(data, null, 2));
          EOF
        env:
          FORCE_RUN: ${{ github.event.inputs.force }}

      - name: Commit jackpot update
        run: |
          git config user.name "jackpot-bot"
          git config user.email "jackpot@bot"
          git add jackpot.json
          git commit -m "ðŸŽ° Jackpot draw update" || exit 0
          git push
