name: Jackpot Draw (Zurich)

on:
  schedule:
    - cron: "0 18 * * *"   # t√§glich 18:00 Z√ºrich
  workflow_dispatch:

jobs:
  draw:
    runs-on: ubuntu-latest
    env:
      TZ: Europe/Zurich

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Run jackpot draw
        run: |
          node <<'EOF'
          const fs = require("fs");

          // Zeitzone explizit setzen
          process.env.TZ = "Europe/Zurich";

          const FILE = "jackpot.json";
          const START = 10;
          const STEP = 10;

          const now = new Date();
          const today = now.toISOString().slice(0, 10);

          const data = JSON.parse(fs.readFileSync(FILE, "utf8"));

          // Nur eine Ziehung pro Tag
          if (data.lastDrawDate === today) {
            console.log("Ziehung heute bereits erfolgt.");
            process.exit(0);
          }

          // Gewinnerlogik (Platzhalter)
          const winnerFound = Math.random() < 0.05;

          data.winnerFound = winnerFound;
          data.lastDrawDate = today;

          // üî• EINZIGE g√ºltige Jackpot-Logik
          data.jackpot = winnerFound
            ? START
            : (typeof data.jackpot === "number" ? data.jackpot : START) + STEP;

          // üî• alte/falsche Felder entfernen
          delete data.amount;

          data.updatedAt = now.toISOString();

          fs.writeFileSync(FILE, JSON.stringify(data, null, 2));
          EOF

      - name: Commit jackpot update
        run: |
          git config user.name "jackpot-bot"
          git config user.email "jackpot@bot"
          git add jackpot.json
          git commit -m "üé∞ Automatische Ziehung 18:00 Z√ºrich" || exit 0
          git push
