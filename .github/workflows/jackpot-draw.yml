name: Jackpot Draw (Zurich)

on:
  # L√§uft regelm√§√üig, Script entscheidet exakt 18:00 Z√ºrich
  schedule:
    - cron: "*/5 * * * *"
  workflow_dispatch:

jobs:
  draw:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Run jackpot draw
        run: |
          node <<'EOF'
          const fs = require("fs");

          const FILE = "jackpot.json";
          const START = 10;
          const STEP = 10;

          // Z√ºrich-Zeit bestimmen (DST-sicher)
          function getZurich(date = new Date()) {
            const f = new Intl.DateTimeFormat("sv-SE", {
              timeZone: "Europe/Zurich",
              year: "numeric", month: "2-digit", day: "2-digit",
              hour: "2-digit", minute: "2-digit", second: "2-digit",
              hour12: false
            }).format(date); // YYYY-MM-DD HH:MM:SS

            const [d, t] = f.split(" ");
            const [hh, mm, ss] = t.split(":").map(Number);
            return { date: d, hh, mm, ss, raw: f };
          }

          const z = getZurich();

          // ‚ùó Ziehung NUR exakt um 18:00 Z√ºrich
          if (!(z.hh === 18 && z.mm === 0)) {
            process.exit(0);
          }

          const data = JSON.parse(fs.readFileSync(FILE, "utf8"));

          // Nur 1 Ziehung pro Z√ºrich-Tag
          if (data.lastDrawDate === z.date) {
            process.exit(0);
          }

          const winnerFound = Math.random() < 0.05;

          data.winnerFound = winnerFound;
          data.lastDrawDate = z.date;

          // üî• EINZIGE g√ºltige Jackpot-Logik
          data.jackpot = winnerFound
            ? START
            : (typeof data.jackpot === "number" ? data.jackpot : START) + STEP;

          // Alte/falsche Felder entfernen
          delete data.amount;

          // Zeit sauber speichern
          data.updatedAtZurich = z.raw;                 // Z√ºrich-Zeit
          data.updatedAtUtc = new Date().toISOString(); // UTC

          fs.writeFileSync(FILE, JSON.stringify(data, null, 2));
          EOF

      - name: Commit jackpot update
        run: |
          git config user.name "jackpot-bot"
          git config user.email "jackpot@bot"
          git add jackpot.json
          git commit -m "üé∞ Automatische Ziehung 18:00 Z√ºrich" || exit 0
          git push
